name: Deploy Frontend to Cloud Run (prototype-1)

on:
    push:
        branches:
            - prototype-1
        paths:
            - "frontend/**"
            - ".github/workflows/deploy-frontend.yml"
    workflow_dispatch:

env:
    PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
    REGION: ${{ secrets.GCP_REGION }}
    SERVICE_NAME: mlviz-frontend

jobs:
    deploy:
        name: Deploy Frontend
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: ${{ secrets.GCP_SA_KEY }}

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2

            - name: Build using Cloud Build
              working-directory: ./frontend
              run: |
                  gcloud builds submit \
                    --config=cloudbuild.yaml \
                    --substitutions=_SERVICE_NAME=${{ env.SERVICE_NAME }},_VITE_API_BASE_URL=${{ secrets.BACKEND_URL }}

            - name: Get latest build ID
              id: get-build
              working-directory: ./frontend
              run: |
                  BUILD_ID=$(gcloud builds list --limit=1 --format="value(id)")
                  echo "build_id=${BUILD_ID}" >> $GITHUB_OUTPUT
                  echo "Latest build ID: ${BUILD_ID}"

            - name: Substitute environment variables in cloudrun.yaml
              working-directory: ./frontend
              run: |
                  sed -i "s|\${PROJECT_ID}|${{ env.PROJECT_ID }}|g" cloudrun.yaml
                  sed -i "s|\${SERVICE_NAME}|${{ env.SERVICE_NAME }}|g" cloudrun.yaml
                  sed -i "s|\${IMAGE_TAG}|${{ steps.get-build.outputs.build_id }}|g" cloudrun.yaml
                  sed -i "s|\${REGION}|${{ env.REGION }}|g" cloudrun.yaml

            - name: Deploy to Cloud Run
              working-directory: ./frontend
              run: |
                  gcloud run services replace cloudrun.yaml \
                    --region ${{ env.REGION }}

            - name: Get service URL
              id: get-url
              run: |
                  SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
                    --platform managed \
                    --region ${{ env.REGION }} \
                    --format 'value(status.url)')
                  echo "url=${SERVICE_URL}" >> $GITHUB_OUTPUT
                  echo "✅ Frontend deployed to: ${SERVICE_URL}"

            - name: Test deployment
              run: |
                  HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" ${{ steps.get-url.outputs.url }})
                  if [ "$HTTP_CODE" -eq 200 ]; then
                    echo "✅ Deployment test passed (HTTP $HTTP_CODE)"
                  else
                    echo "❌ Deployment test failed (HTTP $HTTP_CODE)"
                    exit 1
                  fi
