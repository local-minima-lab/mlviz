name: Deploy Frontend to GCS

on:
    workflow_dispatch:
        inputs:
            backend_url:
                description: "The URL of the backend service (Cloud Run)"
                required: true
                default: "https://mlviz-backend-test-124236563415.asia-southeast1.run.app"
    push:
        branches:
            - main
            - test
        paths:
            - "frontend/**"
            - ".github/workflows/deploy-frontend-gcs.yml"

env:
    PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
    REGION: ${{ secrets.GCP_REGION }}
    BUCKET_NAME: mlviz-frontend

jobs:
    deploy-frontend:
        name: Deploy Frontend to GCS
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: frontend/package-lock.json

            - name: Install dependencies
              working-directory: ./frontend
              run: npm ci

            - name: Build frontend
              working-directory: ./frontend
              env:
                  VITE_API_BASE_URL: ${{ github.event.inputs.backend_url || 'https://mlviz-backend-test-124236563415.asia-southeast1.run.app' }}
              run: npm run build

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: ${{ secrets.GCP_SA_KEY }}

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2

            - name: Create bucket if not exists
              run: |
                  if ! gsutil ls -b gs://${{ env.BUCKET_NAME }} >/dev/null 2>&1; then
                    gsutil mb -l ${{ env.REGION }} gs://${{ env.BUCKET_NAME }}
                    echo "âœ… Bucket gs://${{ env.BUCKET_NAME }} created"
                  else
                    echo "âœ… Bucket gs://${{ env.BUCKET_NAME }} already exists"
                  fi

            - name: Configure Static Website Hosting
              run: |
                  gsutil web set -m index.html -e index.html gs://${{ env.BUCKET_NAME }}
                  echo "âœ… Web hosting configured (index/error: index.html)"

            - name: Upload files to GCS
              run: |
                  gsutil -m rsync -r -d frontend/dist gs://${{ env.BUCKET_NAME }}
                  echo "âœ… Files uploaded to gs://${{ env.BUCKET_NAME }}"

            - name: Make objects public
              run: |
                  gsutil iam ch allUsers:objectViewer gs://${{ env.BUCKET_NAME }}
                  echo "âœ… Bucket made public (objectViewer)"

            - name: Deployment Summary
              run: |
                  echo "======================================"
                  echo "ðŸš€ Frontend Deployed to GCS"
                  echo "======================================"
                  echo "URL: https://storage.googleapis.com/${{ env.BUCKET_NAME }}/index.html"
                  echo "Backend URL used: ${{ github.event.inputs.backend_url || 'https://mlviz-backend-test-124236563415.asia-southeast1.run.app' }}"
                  echo "======================================"
