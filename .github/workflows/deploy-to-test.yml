name: Deploy to Test Environment

on:
    push:
        branches:
            - test
        paths:
            - "backend/**"
            - "frontend/**"
            - ".github/workflows/deploy-to-test.yml"
    workflow_dispatch:

env:
    PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
    REGION: ${{ secrets.GCP_REGION }}
    BACKEND_SERVICE_NAME: mlviz-backend-test
    FRONTEND_SERVICE_NAME: mlviz-frontend-test

jobs:
    deploy-backend:
        name: Deploy Backend
        runs-on: ubuntu-latest
        outputs:
            backend-url: ${{ steps.get-url.outputs.url }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: ${{ secrets.GCP_SA_KEY }}

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2

            - name: Configure Docker for GCR
              run: gcloud auth configure-docker

            - name: Build and push Docker image
              working-directory: ./backend
              run: |
                  IMAGE_NAME="gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_SERVICE_NAME }}"
                  docker build -t "${IMAGE_NAME}:${{ github.sha }}" -t "${IMAGE_NAME}:latest" .
                  docker push "${IMAGE_NAME}:${{ github.sha }}"
                  docker push "${IMAGE_NAME}:latest"

            - name: Deploy to Cloud Run
              run: |
                  gcloud run deploy ${{ env.BACKEND_SERVICE_NAME }} \
                    --image "gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_SERVICE_NAME }}:${{ github.sha }}" \
                    --platform managed \
                    --region ${{ env.REGION }} \
                    --allow-unauthenticated \
                    --port 8080 \
                    --memory 512Mi \
                    --cpu 1 \
                    --min-instances 0 \
                    --max-instances 10 \
                    --set-env-vars "DEBUG=false"

            - name: Get service URL
              id: get-url
              run: |
                  SERVICE_URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE_NAME }} \
                    --platform managed \
                    --region ${{ env.REGION }} \
                    --format 'value(status.url)')
                  echo "url=${SERVICE_URL}" >> $GITHUB_OUTPUT
                  echo "‚úÖ Backend deployed to: ${SERVICE_URL}"

            - name: Test deployment
              run: |
                  curl -f ${{ steps.get-url.outputs.url }}/health || exit 1
                  echo "‚úÖ Health check passed"

    deploy-frontend:
        name: Deploy Frontend
        runs-on: ubuntu-latest
        needs: deploy-backend
        outputs:
            frontend-url: ${{ steps.get-url.outputs.url }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: ${{ secrets.GCP_SA_KEY }}

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2

            - name: Build using Cloud Build
              working-directory: ./frontend
              run: |
                  gcloud builds submit \
                    --config=cloudbuild.yaml \
                    --substitutions=_VITE_API_BASE_URL=${{ needs.deploy-backend.outputs.backend-url }},_BACKEND_URL=${{ needs.deploy-backend.outputs.backend-url }}

            - name: Deploy to Cloud Run
              run: |
                  gcloud run deploy ${{ env.FRONTEND_SERVICE_NAME }} \
                    --image gcr.io/${{ env.PROJECT_ID }}/frontend:latest \
                    --region ${{ env.REGION }} \
                    --allow-unauthenticated \
                    --platform managed \
                    --port 8080 \
                    --memory 512Mi \
                    --set-env-vars BACKEND_URL=${{ needs.deploy-backend.outputs.backend-url }}

            - name: Get service URL
              id: get-url
              run: |
                  SERVICE_URL=$(gcloud run services describe ${{ env.FRONTEND_SERVICE_NAME }} \
                    --platform managed \
                    --region ${{ env.REGION }} \
                    --format 'value(status.url)')
                  echo "url=${SERVICE_URL}" >> $GITHUB_OUTPUT
                  echo "‚úÖ Frontend deployed to: ${SERVICE_URL}"

            - name: Test deployment
              run: |
                  HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" ${{ steps.get-url.outputs.url }})
                  if [ "$HTTP_CODE" -eq 200 ]; then
                    echo "‚úÖ Deployment test passed (HTTP $HTTP_CODE)"
                  else
                    echo "‚ùå Deployment test failed (HTTP $HTTP_CODE)"
                    exit 1
                  fi

    update-cors:
        name: Update Backend CORS
        runs-on: ubuntu-latest
        needs: [deploy-backend, deploy-frontend]

        steps:
            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: ${{ secrets.GCP_SA_KEY }}

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2

            - name: Update backend CORS
              run: |
                  echo "Updating backend CORS to allow: ${{ needs.deploy-frontend.outputs.frontend-url }}"
                  gcloud run services update ${{ env.BACKEND_SERVICE_NAME }} \
                    --region ${{ env.REGION }} \
                    --update-env-vars FRONTEND_URL=${{ needs.deploy-frontend.outputs.frontend-url }}
                  echo "‚úÖ Backend CORS updated"

            - name: Deployment summary
              run: |
                  echo "======================================"
                  echo "üöÄ Test Environment Deployment Complete"
                  echo "======================================"
                  echo "Backend:  ${{ needs.deploy-backend.outputs.backend-url }}"
                  echo "Frontend: ${{ needs.deploy-frontend.outputs.frontend-url }}"
                  echo "======================================"
