name: Deploy Backend to Cloud Run (prototype-1)

on:
    push:
        branches:
            - prototype-1
        paths:
            - "backend/**"
            - ".github/workflows/deploy-backend.yml"
    workflow_dispatch: # Allow manual triggers

env:
    PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
    REGION: ${{ secrets.GCP_REGION }}
    SERVICE_NAME: backend

jobs:
    deploy:
        name: Deploy Backend
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: ${{ secrets.GCP_SA_KEY }}

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2

            - name: Configure Docker for GCR
              run: gcloud auth configure-docker

            - name: Build and push Docker image
              working-directory: ./backend
              run: |
                  IMAGE_NAME="gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}"
                  docker build -t "${IMAGE_NAME}:${{ github.sha }}" -t "${IMAGE_NAME}:latest" .
                  docker push "${IMAGE_NAME}:${{ github.sha }}"
                  docker push "${IMAGE_NAME}:latest"

            - name: Deploy to Cloud Run
              run: |
                  gcloud run deploy ${{ env.SERVICE_NAME }} \
                    --image "gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }}" \
                    --platform managed \
                    --region ${{ env.REGION }} \
                    --allow-unauthenticated \
                    --port 8080 \
                    --memory 512Mi \
                    --cpu 1 \
                    --min-instances 0 \
                    --max-instances 10 \
                    --set-env-vars "DEBUG=false" \
                    --set-env-vars "FRONTEND_URL=${{ secrets.FRONTEND_URL }}"

            - name: Get service URL
              id: get-url
              run: |
                  SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
                    --platform managed \
                    --region ${{ env.REGION }} \
                    --format 'value(status.url)')
                  echo "url=${SERVICE_URL}" >> $GITHUB_OUTPUT
                  echo "✅ Backend deployed to: ${SERVICE_URL}"

            - name: Test deployment
              run: |
                  curl -f ${{ steps.get-url.outputs.url }}/health || exit 1
                  echo "✅ Health check passed"
