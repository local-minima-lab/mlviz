name: Deploy (Test)

on:
    push:
        branches:
            - test
        paths:
            - "frontend/**"
            - "quartz/**"
            - ".github/workflows/deploy-frontend-gcs-test.yml"
    workflow_dispatch:

env:
    PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
    REGION: ${{ secrets.GCP_REGION }}
    BUCKET_NAME: mlviz-test
    BACKEND_SERVICE_NAME: mlviz-backend-test

jobs:
    deploy-backend:
        name: Deploy Backend
        runs-on: ubuntu-latest
        outputs:
            backend-url: ${{ steps.get-url.outputs.url }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: ${{ secrets.GCP_SA_KEY }}

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2

            - name: Configure Docker for GCR
              run: gcloud auth configure-docker

            - name: Build and push Docker image
              working-directory: ./backend
              run: |
                  IMAGE_NAME="gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_SERVICE_NAME }}"
                  docker build -t "${IMAGE_NAME}:${{ github.sha }}" -t "${IMAGE_NAME}:latest" .
                  docker push "${IMAGE_NAME}:${{ github.sha }}"
                  docker push "${IMAGE_NAME}:latest"

            - name: Deploy to Cloud Run
              run: |
                  gcloud run deploy ${{ env.BACKEND_SERVICE_NAME }} \
                    --image "gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_SERVICE_NAME }}:${{ github.sha }}" \
                    --platform managed \
                    --region ${{ env.REGION }} \
                    --allow-unauthenticated \
                    --port 8080 \
                    --memory 512Mi \
                    --cpu 1 \
                    --min-instances 0 \
                    --max-instances 10 \
                    --set-env-vars "DEBUG=false"

            - name: Get service URL
              id: get-url
              run: |
                  SERVICE_URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE_NAME }} \
                    --platform managed \
                    --region ${{ env.REGION }} \
                    --format 'value(status.url)')
                  echo "url=${SERVICE_URL}" >> $GITHUB_OUTPUT
                  echo "âœ… Backend deployed to: ${SERVICE_URL}"

            - name: Test deployment
              run: |
                  curl -f ${{ steps.get-url.outputs.url }}/health || exit 1
                  echo "âœ… Health check passed"

    deploy-frontend:
        name: Deploy Frontend to GCS
        runs-on: ubuntu-latest
        needs: deploy-backend

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: frontend/package-lock.json

            - name: Install dependencies
              working-directory: ./frontend
              run: npm ci

            - name: Build frontend with backend URL
              working-directory: ./frontend
              env:
                  VITE_API_BASE_URL: ${{ needs.deploy-backend.outputs.backend-url }}
                  VITE_FAVICON: /mlviz_orange.png
                  VITE_TITLE: mlviz (test)
                  VITE_CONFIG_FILE: test
              run: |
                  echo "Building with backend URL: $VITE_API_BASE_URL"
                  npm run build

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: ${{ secrets.GCP_SA_KEY }}

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2

            - name: Create bucket if not exists
              run: |
                  if ! gsutil ls -b gs://${{ env.BUCKET_NAME }} > /dev/null 2>&1; then
                    gsutil mb -l ${{ env.REGION }} gs://${{ env.BUCKET_NAME }}
                    echo "âœ… Bucket gs://${{ env.BUCKET_NAME }} created"
                  else
                    echo "âœ… Bucket gs://${{ env.BUCKET_NAME }} already exists"
                  fi

            - name: Configure Static Website Hosting
              run: |
                  gsutil web set -m index.html -e index.html gs://${{ env.BUCKET_NAME }}
                  echo "âœ… Web hosting configured (index/error: index.html)"

            - name: Upload files to GCS
              run: |
                  gsutil -m rsync -r -d frontend/dist gs://${{ env.BUCKET_NAME }}
                  echo "âœ… Files uploaded to gs://${{ env.BUCKET_NAME }}"

            - name: Make objects public
              run: |
                  gsutil iam ch allUsers:objectViewer gs://${{ env.BUCKET_NAME }}
                  echo "âœ… Bucket made public (objectViewer)"

            - name: Set cache control headers
              run: |
                  # Cache assets for 1 year
                  gsutil -m setmeta -h "Cache-Control:public, max-age=31536000" gs://${{ env.BUCKET_NAME }}/assets/**
                  # Don't cache index.html
                  gsutil setmeta -h "Cache-Control:no-cache, no-store, must-revalidate" gs://${{ env.BUCKET_NAME }}/index.html
                  echo "âœ… Cache headers set"

            - name: Deployment Summary
              run: |
                  echo "======================================"
                  echo "ðŸš€ Test Frontend Deployed to GCS"
                  echo "======================================"
                  echo "Frontend URL: https://${{ env.BUCKET_NAME }}.storage.googleapis.com/index.html"
                  echo "Backend URL:  ${{ needs.deploy-backend.outputs.backend-url }}"
                  echo "======================================"

    deploy-docs:
        name: Deploy Documentation
        runs-on: ubuntu-latest
        needs: deploy-frontend

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"
                  cache: "npm"
                  cache-dependency-path: quartz/package-lock.json

            - name: Install Quartz dependencies
              working-directory: ./quartz
              run: npm ci

            - name: Build Quartz documentation
              working-directory: ./quartz
              env:
                  QUARTZ_BASE_URL: "${{ env.BUCKET_NAME }}.storage.googleapis.com/docs"
              run: |
                  echo "Building Quartz with base URL: $QUARTZ_BASE_URL"
                  npx quartz build

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: ${{ secrets.GCP_SA_KEY }}

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2

            - name: Upload docs to GCS
              run: |
                  gsutil -m rsync -r -d quartz/public gs://${{ env.BUCKET_NAME }}/docs
                  echo "âœ… Documentation uploaded to gs://${{ env.BUCKET_NAME }}/docs"

            - name: Set cache control headers for docs
              run: |
                  # Cache static assets for 1 year
                  gsutil -m setmeta -h "Cache-Control:public, max-age=31536000" gs://${{ env.BUCKET_NAME }}/docs/static/** || true
                  # Don't cache HTML files
                  gsutil -m setmeta -h "Cache-Control:no-cache, no-store, must-revalidate" "gs://${{ env.BUCKET_NAME }}/docs/**.html" || true
                  echo "âœ… Cache headers set for documentation"

            - name: Documentation Deployment Summary
              run: |
                  echo "======================================"
                  echo "ðŸ“š Documentation Deployed"
                  echo "======================================"
                  echo "Docs URL: https://${{ env.BUCKET_NAME }}.storage.googleapis.com/docs/"
                  echo "======================================"

    update-backend-cors:
        name: Update Backend CORS
        runs-on: ubuntu-latest
        needs: [deploy-backend, deploy-frontend]

        steps:
            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: ${{ secrets.GCP_SA_KEY }}

            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@v2

            - name: Update backend CORS to allow GCS frontend
              run: |
                  FRONTEND_URL="https://${{ env.BUCKET_NAME }}.storage.googleapis.com"
                  echo "Updating backend CORS to allow: $FRONTEND_URL"
                  gcloud run services update ${{ env.BACKEND_SERVICE_NAME }} \
                    --region ${{ env.REGION }} \
                    --update-env-vars FRONTEND_URL=$FRONTEND_URL
                  echo "âœ… Backend CORS updated"

            - name: Final Summary
              run: |
                  echo "======================================"
                  echo "âœ… Test Environment Deployment Complete"
                  echo "======================================"
                  echo "Frontend: https://${{ env.BUCKET_NAME }}.storage.googleapis.com/index.html"
                  echo "Backend:  ${{ needs.deploy-backend.outputs.backend-url }}"
                  echo "CORS configured for frontend URL"
                  echo "======================================"
